-- USER COMMANDS
CREATE USER 'xxxx'@'%' IDENTIFIED BY 'xxxx@2023';
GRANT ALL PRIVILEGES ON *.* TO 'xxxx'@'%';
GRANT USAGE ON EVRYJEWELS.* TO 'xxxx'@'%';
GRANT SELECT, INSERT, UPDATE, DELETE ON EVRYJEWELS.* TO 'xxxx'@'%';

-- Schemas
CREATE SCHEMA IF NOT EXISTS EVRYJEWELS;

-- Tables

-- TEMPLATE TABLE
CREATE TABLE EVRYJEWELS.TABLE_NAME (
    -- MANDATORY COLUMNS!!!
    ROW_ID VARCHAR(15) NOT NULL,                    			-- ID
    CREATED DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL, 	-- CREATED DATE
    CREATED_BY VARCHAR(200) NOT NULL,               			-- CREATED BY
    LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL, -- UPDATED DATE
    LAST_UPD_BY VARCHAR(200) NOT NULL,              			-- UPDATED BY
    MODIFICATION_NUM BIGINT DEFAULT 0 NOT NULL,    				-- TOTAL NUMBER OF ID UPDATES
    DB_LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),       -- LAST DATE OF TABLE UPDATE
    -- OTHER COLUMNS HERE!!!
    EXAMPLE_COLUMN VARCHAR(10),
    -- MANDATORY PRIMARY KEY
    PRIMARY KEY (ROW_ID)
);

-- MANDATORY TRIGGER CREATION
DELIMITER //
CREATE TRIGGER EVRYJEWELS.TABLE_NAME
BEFORE UPDATE ON EVRYJEWELS.TABLE_NAME
FOR EACH ROW
BEGIN
    SET NEW.LAST_UPD = CURRENT_TIMESTAMP(6),
        NEW.LAST_UPD_BY = '0-1',
        NEW.MODIFICATION_NUM = NEW.MODIFICATION_NUM + 1,
        NEW.DB_LAST_UPD = CURRENT_TIMESTAMP(6); 
END;
// DELIMITER ;

-- ROW_ID
-- ROW_ID GENERATION TABLE
-- PLEASE, NEVER UPDATE THE TABLE BELOW BY HAND!!!!
CREATE TABLE EVRYJEWELS.ROW_ID (
    ROW_ID VARCHAR(15) NOT NULL,                    			-- ID
    CREATED DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL, 	-- CREATED DATE
    CREATED_BY VARCHAR(200) NOT NULL,               			-- CREATED BY
    LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL, -- UPDATED DATE
    LAST_UPD_BY VARCHAR(200) NOT NULL,              			-- UPDATED BY
    MODIFICATION_NUM BIGINT DEFAULT 0 NOT NULL,    				-- TOTAL NUMBER OF ID UPDATES
    DB_LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),     	-- LAST DATE OF TABLE UPDATE
    NEXT_ID VARCHAR(50) NOT NULL,                				-- NEXT ROW ID
    PREFIX VARCHAR(15) DEFAULT '0' NOT NULL,            		-- PREFIX
    SUFFIX VARCHAR(50) DEFAULT '0' NOT NULL,            		-- SUFFIX
    COUNTER INT DEFAULT 0 NOT NULL,                             -- COUNTER

    PRIMARY KEY (ROW_ID)
);

-- ORDER_STAGING (Not being used anymore, using RabbitMQ to queue orders from Shopify)
CREATE TABLE EVRYJEWELS.ORDER_STAGING (
    ROW_ID BIGINT PRIMARY KEY AUTO_INCREMENT,
    CREATED DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
    ORDER_JSON JSON NOT NULL
);

CREATE INDEX IDX_ORDER_STAGING_CREATED ON EVRYJEWELS.ORDER_STAGING(CREATED);

-- ORDERS
CREATE TABLE EVRYJEWELS.ORDER (
    ROW_ID VARCHAR(50) NOT NULL,
    CREATED DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
    CREATED_BY VARCHAR(200) NOT NULL,
    LAST_UPD DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
    LAST_UPD_BY VARCHAR(200) NOT NULL,
    MODIFICATION_NUM BIGINT NOT NULL DEFAULT '0',
    DB_LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),
    APP_ID VARCHAR(500) DEFAULT NULL,
    BILLING_ADDRESS JSON DEFAULT NULL,
    BROWSER_IP VARCHAR(50) DEFAULT NULL,
    BUYER_ACCEPTS_MARKETING TINYINT(1) DEFAULT NULL,
    CANCEL_REASON VARCHAR(255) DEFAULT NULL,
    CANCELLED_AT DATETIME(6) DEFAULT NULL,
    CART_TOKEN VARCHAR(1000) DEFAULT NULL,
    CHECKOUT_TOKEN VARCHAR(1000) DEFAULT NULL,
    CLIENT_DETAILS JSON DEFAULT NULL,
    CLOSED_AT DATETIME(6) DEFAULT NULL,
    COMPANY JSON DEFAULT NULL,
    CONFIRMATION_NUMBER VARCHAR(255) DEFAULT NULL,
    CREATED_AT DATETIME(6) DEFAULT NULL,
    COUNTRY_CODE VARCHAR(5) DEFAULT NULL,
    CURRENCY VARCHAR(20) DEFAULT NULL,
    CURRENT_TOTAL_ADDITIONAL_FEES_SET JSON DEFAULT NULL,
    CURRENT_TOTAL_DISCOUNTS VARCHAR(20) DEFAULT NULL,
    CUSTOMER_ID VARCHAR(500) DEFAULT NULL,
    CUSTOMER_LOCALE VARCHAR(100) DEFAULT NULL,
    DELIVERY_STATUS VARCHAR(50) DEFAULT NULL,
    DISCOUNT_APPLICATIONS JSON DEFAULT NULL,
    DISCOUNT_CODES JSON DEFAULT NULL,
    EMAIL VARCHAR(500) DEFAULT NULL,
    ESTIMATED_TAXES TINYINT(1) DEFAULT NULL,
    FINANCIAL_STATUS VARCHAR(1000) DEFAULT NULL,
    FULFILLMENTS JSON DEFAULT NULL,
    FULFILLMENT_STATUS VARCHAR(255) DEFAULT NULL,
    ID VARCHAR(500) NOT NULL,
    LANDING_SITE TEXT,
    LINE_ITEMS JSON DEFAULT NULL,
    LOCATION_ID VARCHAR(500) DEFAULT NULL,
    MERCHANT_OF_RECORD_APP_ID VARCHAR(500) DEFAULT NULL,
    NAME VARCHAR(100) DEFAULT NULL,
    NOTE TEXT,
    NOTE_ATTRIBUTES JSON DEFAULT NULL,
    NUMBER BIGINT DEFAULT NULL,
    ORDER_NUMBER BIGINT DEFAULT NULL,
    ORIGINAL_TOTAL_ADDITIONAL_FEES_SET VARCHAR(1000) DEFAULT NULL,
    ORIGINAL_TOTAL_DUTIES_SET JSON DEFAULT NULL,
    PAYMENT_TERMS JSON DEFAULT NULL,
    PAYMENT_GATEWAY_NAMES JSON DEFAULT NULL,
    PHONE VARCHAR(100) DEFAULT NULL,
    PO_NUMBER VARCHAR(100) DEFAULT NULL,
    PRESENTMENT_CURRENCY VARCHAR(20) DEFAULT NULL,
    PROCESSED_AT DATETIME(6) DEFAULT NULL,
    REFERRING_SITE TEXT,
    REFUNDS JSON DEFAULT NULL,
    SHIPPING_ADDRESS JSON DEFAULT NULL,
    SHIPPING_LINES JSON DEFAULT NULL,
    SOURCE_NAME TEXT,
    SOURCE_IDENTIFIER TEXT,
    SOURCE_URL TEXT,
    SUBTOTAL_PRICE VARCHAR(20) DEFAULT NULL,
    SUBTOTAL_PRICE_SET JSON DEFAULT NULL,
    TAGS TEXT,
    TAX_LINES JSON DEFAULT NULL,
    TAXES_INCLUDED TINYINT(1) DEFAULT NULL,
    TEST TINYINT(1) DEFAULT NULL,
    TOTAL_DISCOUNTS VARCHAR(20) DEFAULT NULL,
    TOTAL_DISCOUNTS_SET JSON DEFAULT NULL,
    TOTAL_LINE_ITEMS_PRICE VARCHAR(20) DEFAULT NULL,
    TOTAL_LINE_ITEMS_PRICE_SET JSON DEFAULT NULL,
    TOTAL_OUTSTANDING VARCHAR(20) DEFAULT NULL,
    TOTAL_PRICE VARCHAR(20) DEFAULT NULL,
    TOTAL_PRICE_SET JSON DEFAULT NULL,
    TOTAL_SHIPPING_PRICE_SET JSON DEFAULT NULL,
    TOTAL_TAX VARCHAR(20) DEFAULT NULL,
    TOTAL_TAX_SET JSON DEFAULT NULL,
    TOTAL_TIP_RECEIVED VARCHAR(20) DEFAULT NULL,
    TOTAL_WEIGHT BIGINT DEFAULT NULL,
    UPDATED_AT DATETIME(6) DEFAULT NULL,
    USER_ID VARCHAR(500) DEFAULT NULL,
    ORDER_STATUS_URL TEXT,
    TOKEN VARCHAR(1000) DEFAULT NULL,
    ADMIN_GRAPHQL_API_ID VARCHAR(500) DEFAULT NULL,
    CHECKOUT_ID BIGINT DEFAULT NULL,
    CONFIRMED TINYINT(1) DEFAULT NULL,
    CONTACT_EMAIL VARCHAR(500) DEFAULT NULL,
    DEVICE_ID VARCHAR(500) DEFAULT NULL,
    LANDING_SITE_REF VARCHAR(500) DEFAULT NULL,
    REFERENCE VARCHAR(500) DEFAULT NULL,
    TAX_EXEMPT TINYINT(1) DEFAULT NULL,
    CUSTOMER JSON DEFAULT NULL,
    PROCESSED_DATE DATETIME(6) DEFAULT NULL,
    PRINTED_DATE DATETIME(6) DEFAULT NULL,
    FULFILLED_DATE DATETIME(6) DEFAULT NULL,
    SHIPPING_LABEL_URL VARCHAR(1000) DEFAULT NULL,
    TRACKING_INFO JSON DEFAULT NULL,
    ERROR_DESCRIPTION TEXT,

    PRIMARY KEY (ROW_ID)
);

DELIMITER //
CREATE TRIGGER EVRYJEWELS.ORDER_INSERT
BEFORE INSERT ON EVRYJEWELS.ORDER
FOR EACH ROW
BEGIN
    SET NEW.CREATED_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1),
		NEW.LAST_UPD_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1);
END
// DELIMITER ;

DELIMITER //
CREATE TRIGGER EVRYJEWELS.ORDER_UPDATE
BEFORE UPDATE ON EVRYJEWELS.ORDER
FOR EACH ROW
BEGIN
    SET NEW.LAST_UPD = CURRENT_TIMESTAMP(6),
        NEW.LAST_UPD_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1),
        NEW.MODIFICATION_NUM = NEW.MODIFICATION_NUM + 1,
        NEW.DB_LAST_UPD = CURRENT_TIMESTAMP(6); 
END;
// DELIMITER ;

CREATE INDEX IDX_ORDER_CREATED ON EVRYJEWELS.ORDER(CREATED);
CREATE INDEX IDX_ORDER_CREATED_AT ON EVRYJEWELS.ORDER(CREATED_AT);
CREATE INDEX IDX_ORDER_PRINTED_DATE ON EVRYJEWELS.ORDER(PRINTED_DATE);
CREATE INDEX IDX_ORDER_FULFILLED_DATE ON EVRYJEWELS.ORDER(FULFILLED_DATE);
CREATE INDEX IDX_ORDER_PROCESSED_DATE ON EVRYJEWELS.ORDER(PROCESSED_DATE);

-- ORDER_LINE_ITEM
CREATE TABLE EVRYJEWELS.ORDER_LINE_ITEM (
    ROW_ID VARCHAR(15) NOT NULL,                                -- ID
    CREATED DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL,  -- CREATED DATE
    CREATED_BY VARCHAR(200) NOT NULL,                            -- CREATED BY
    LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL, -- UPDATED DATE
    LAST_UPD_BY VARCHAR(200) NOT NULL,                           -- UPDATED BY
    MODIFICATION_NUM BIGINT DEFAULT 0 NOT NULL,                 -- TOTAL NUMBER OF ID UPDATES
    DB_LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),       -- LAST DATE OF TABLE UPDATE
    ID VARCHAR(500) UNIQUE NOT NULL,
    ORDER_ID VARCHAR(500),
    ATTRIBUTED_STAFFS JSON,
    FULFILLABLE_QUANTITY BIGINT,
    FULFILLMENT_SERVICE VARCHAR(255),
    FULFILLMENT_STATUS VARCHAR(255),
    GRAMS BIGINT,
    PRICE VARCHAR(20),
    PRICE_SET JSON,
    PRODUCT_EXISTS BOOLEAN,
    PRODUCT_ID BIGINT,
    QUANTITY BIGINT,
    REQUIRES_SHIPPING BOOLEAN,
    SKU VARCHAR(50),
    TITLE VARCHAR(1000),
    VARIANT_ID BIGINT,
    VARIANT_INVENTORY_MANAGEMENT VARCHAR(255),
    VARIANT_TITLE VARCHAR(255),
    VENDOR VARCHAR(255),
    NAME VARCHAR(1000),
    GIFT_CARD BOOLEAN,
    PROPERTIES JSON,
    TAXABLE BOOLEAN,
    TAX_LINES JSON,
    TOTAL_DISCOUNT VARCHAR(20),
    TOTAL_DISCOUNT_SET JSON,
    DISCOUNT_ALLOCATIONS JSON,
    DUTIES JSON,
    ADMIN_GRAPHQL_API_ID VARCHAR(500),

    PRIMARY KEY (ROW_ID)
);

DELIMITER //
CREATE TRIGGER EVRYJEWELS.ORDER_LINE_ITEM
BEFORE UPDATE ON EVRYJEWELS.ORDER_LINE_ITEM
FOR EACH ROW
BEGIN
    SET NEW.LAST_UPD = CURRENT_TIMESTAMP(6),
        NEW.LAST_UPD_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1),
        NEW.MODIFICATION_NUM = NEW.MODIFICATION_NUM + 1,
        NEW.DB_LAST_UPD = CURRENT_TIMESTAMP(6); 
END;
// DELIMITER ;

CREATE INDEX IDX_OITEM_CREATED ON EVRYJEWELS.ORDER_LINE_ITEM(CREATED);
CREATE INDEX IDX_OITEM_ORDER_ID ON EVRYJEWELS.ORDER_LINE_ITEM(ORDER_ID);
CREATE INDEX IDX_OITEM_PRODUCT_ID ON EVRYJEWELS.ORDER_LINE_ITEM(PRODUCT_ID);
CREATE INDEX IDX_OITEM_VARIANT_ID ON EVRYJEWELS.ORDER_LINE_ITEM(VARIANT_ID);
CREATE INDEX IDX_OITEM_QUANTITY ON EVRYJEWELS.ORDER_LINE_ITEM(QUANTITY);

-- PRODUCT
CREATE TABLE EVRYJEWELS.PRODUCT (
    ROW_ID VARCHAR(50) NOT NULL,                                    -- ID
    CREATED DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL,      -- CRIADO
    CREATED_BY VARCHAR(200) NOT NULL,                                -- CRIADO POR
    LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL,     -- ATUALIZADO
    LAST_UPD_BY VARCHAR(200) NOT NULL,                               -- ATUALIZADO POR
    MODIFICATION_NUM BIGINT DEFAULT 0 NOT NULL,                     -- NUMERO DE MODIFICACAO
    DB_LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL,  -- LAST DATE OF TABLE UPDATE
    ID BIGINT UNIQUE NOT NULL,
    TITLE VARCHAR(255),
    BODY_HTML TEXT,
    VENDOR VARCHAR(255),
    PRODUCT_TYPE VARCHAR(255),
    CREATED_AT DATETIME(6),
    HANDLE VARCHAR(255),
    UPDATED_AT DATETIME(6),
    PUBLISHED_AT DATETIME(6),
    TEMPLATE_SUFFIX VARCHAR(255),
    PUBLISHED_SCOPE VARCHAR(255),
    TAGS VARCHAR(255),
    STATUS VARCHAR(255),
    ADMIN_GRAPHQL_API_ID VARCHAR(500),
    VARIANTS JSON,
    OPTIONS JSON,
    IMAGES JSON,
    IMAGE JSON,

    PRIMARY KEY (ROW_ID)
);

DELIMITER //
CREATE TRIGGER EVRYJEWELS.PRODUCT_UPDATE
BEFORE UPDATE ON EVRYJEWELS.PRODUCT
FOR EACH ROW
BEGIN
    SET NEW.LAST_UPD = CURRENT_TIMESTAMP(6),
        NEW.LAST_UPD_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1),
        NEW.MODIFICATION_NUM = NEW.MODIFICATION_NUM + 1,
        NEW.DB_LAST_UPD = CURRENT_TIMESTAMP(6); 
END;
// DELIMITER ;

-- LOGS
CREATE TABLE EVRYJEWELS.LOGS (
    ROW_ID VARCHAR(50) NOT NULL,
    CREATED DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
    CREATED_BY VARCHAR(200) NOT NULL,
    LAST_UPD DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
    LAST_UPD_BY VARCHAR(200) NOT NULL,
    MODIFICATION_NUM BIGINT NOT NULL DEFAULT '0',
    DB_LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),
    REPOSITORY_NAME VARCHAR(500),
    MODULE_NAME VARCHAR(500),
    FUNCTION_NAME VARCHAR(500),
    ERROR_CODE VARCHAR(500),
    ERROR_MESSAGE TEXT,
    ADDITIONAL_DETAILS LONGTEXT,
    ERROR_SEVERITY VARCHAR(50) DEFAULT 'Debugging',

    PRIMARY KEY(ROW_ID)
);

DELIMITER //
CREATE TRIGGER EVRYJEWELS.LOGS
BEFORE UPDATE ON EVRYJEWELS.LOGS
FOR EACH ROW
BEGIN
    SET NEW.LAST_UPD = CURRENT_TIMESTAMP(6),
        NEW.LAST_UPD_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1),
        NEW.MODIFICATION_NUM = NEW.MODIFICATION_NUM + 1,
        NEW.DB_LAST_UPD = CURRENT_TIMESTAMP(6); 
END;
// DELIMITER ;

-- WEBHOOK_LOGS
CREATE TABLE EVRYJEWELS.WEBHOOK_LOGS (
    ROW_ID INT PRIMARY KEY AUTO_INCREMENT,                              -- ID
    CREATED DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL, -- CREATED DATE

    WEBHOOK_NAME VARCHAR(200) NOT NULL
);

CREATE INDEX IDX_WEBHOOK_CREATED ON EVRYJEWELS.WEBHOOK_LOGS(CREATED);
CREATE INDEX IDX_WEBHOOK_NAME ON EVRYJEWELS.WEBHOOK_LOGS(WEBHOOK_NAME);

-- SYSTEM PREFERENCES
-- SYSTEM PREFERENCES
CREATE TABLE EVRYJEWELS.SYS_PREF (
    ROW_ID VARCHAR(15) NOT NULL,                                -- ID
    CREATED DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL,  -- CREATED DATE
    CREATED_BY VARCHAR(50) NOT NULL,                            -- CREATED BY
    LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) NOT NULL, -- UPDATED DATE
    LAST_UPD_BY VARCHAR(15) NOT NULL,                           -- UPDATED BY
    MODIFICATION_NUM BIGINT DEFAULT 0 NOT NULL,                 -- TOTAL NUMBER OF ID UPDATES
    DB_LAST_UPD DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),       -- LAST DATE OF TABLE UPDATE
    PREF_NAME VARCHAR(100) NOT NULL UNIQUE,
    PREF_VAL VARCHAR(100),
    COMMENTS VARCHAR(2500),

    PRIMARY KEY (ROW_ID)
);

DELIMITER //
CREATE TRIGGER EVRYJEWELS.SYS_PREF_INSERT
BEFORE INSERT ON EVRYJEWELS.SYS_PREF
FOR EACH ROW
BEGIN
    SET NEW.CREATED_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1),
		NEW.LAST_UPD_BY = SUBSTRING_INDEX(CURRENT_USER(), '@', 1);
END
// DELIMITER ;

DELIMITER //
CREATE TRIGGER EVRYJEWELS.SYS_PREF_UPDATE
BEFORE UPDATE ON EVRYJEWELS.SYS_PREF
FOR EACH ROW
BEGIN
    SET NEW.LAST_UPD = CURRENT_TIMESTAMP(6),
    NEW.LAST_UPD_BY = '0-1',
    NEW.MODIFICATION_NUM = NEW.MODIFICATION_NUM + 1,
    NEW.DB_LAST_UPD = CURRENT_TIMESTAMP(6); 
END;
// DELIMITER ;
